# AI_bot_7.py 改造说明文档

## 1. 算法2的集成位置和核心逻辑

### 集成位置
- **主要位置**: `hybrid_search` 函数和新增的 `rrf_fusion` 函数
- **辅助位置**: 保留了原有的 `retrieve_from_es` 函数，但其底层调用的 `hybrid_search` 已优化

### 核心逻辑
1. **分离搜索**: 分别执行关键词搜索和向量搜索
2. **RRF融合**: 使用RRF (Reciprocal Rank Fusion) 算法融合两种搜索结果
3. **优化排序**: 基于RRF分数重新排序，提高检索准确性

## 2. 与原有代码的差异点

### 新增函数
- `rrf_fusion(keyword_response, vector_response, k=60, top_k=5)`: 实现RRF算法融合

### 修改函数
- `hybrid_search`: 重构为先分别执行两种搜索，再使用RRF算法融合结果

### 保留功能
- 所有原有配置项（ES_URL、API密钥等）
- GUI/TUI交互流程
- 错误处理机制
- 与custom_webui.py的兼容性

## 3. 算法2的效果验证方法

### 测试用例1
- **输入**: "雇主责任险与工伤保险的区别"
- **预期输出**: 检索结果应同时考虑关键词匹配度和语义相似性，返回《2-雇主责任险.txt》等相关文档
- **验证点**: RRF融合后的排序是否比单独使用关键词或向量搜索更合理

### 测试用例2
- **输入**: "施工保包含哪些内容"
- **预期输出**: 返回《5-施工保.txt》等文档，且RRF融合结果应比单一搜索策略更全面
- **验证点**: 是否能同时捕捉到关键词匹配和语义相关的内容

### 测试用例3
- **输入**: "财产一切险理赔流程"
- **预期输出**: 返回《6-财产一切险.txt》等相关文档
- **验证点**: 在混合搜索部分组件失败时，系统是否能正常工作

## 4. 兼容性说明

改造后的AI_bot_7.py完全兼容原有的custom_webui.py调用逻辑：
- `retrieve_from_es_func` 函数调用不变
- `hybrid_search_func` 函数调用不变
- 返回的数据格式与原版本保持一致
- 所有字段（file_name, page_num, score等）保持不变
- 错误处理风格与原代码一致

### 关键兼容性保证
1. **函数签名**: 所有对外暴露的函数签名保持不变
2. **数据结构**: 返回的文档结构与原代码一致
3. **异常处理**: 保持与原代码相同的异常处理风格
4. **配置项**: 所有环境变量和配置项保持不变